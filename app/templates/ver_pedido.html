<c-header>
</c-header>
{% load static %}
{% load crispy_forms_tags %}
<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Finalizar Pedido - Caliandra</title>
    <link rel="stylesheet" href="{% static 'app/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Aguafina+Script&amp;display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Aldrich&amp;display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alexandria&amp;display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Amethysta&amp;display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bad+Script&amp;display=swap">
    <link rel="stylesheet" href="{% static 'app/fonts/fontawesome-all.min.css' %}">
    <link rel="stylesheet" href="{% static 'app/css/bss-overrides.css' %}">
    <link rel="stylesheet" href="{% static 'app/css/Hero-Travel-.css' %}">
    <link rel="stylesheet" href="{% static 'app/css/Navbar-Centered-Links-icons.css' %}">
    <link rel="stylesheet" href="{% static 'app/css/text-box.css' %}">
</head>

<body style="background: #fffedf;">
    <div class="container mt-5">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% if pedido and itens %}
            <div class="row">
                <!-- Resumo do Pedido -->
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h4 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Resumo do Seu Pedido</h4>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Produto</th>
                                            <th>Descrição</th>
                                            <th class="text-center">Qtd.</th>
                                            <th class="text-end">Valor Unit.</th>
                                            <th class="text-end">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in itens %}
                                        <tr>
                                            <td>
                                                <strong>{{ item.produto.nome }}</strong>
                                                <br><small class="text-muted">{{ item.produto.marca }}</small>
                                            </td>
                                            <td>
                                                <small>{{ item.produto.descricao|truncatewords:8 }}</small>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-primary">{{ item.quantidade }}</span>
                                            </td>
                                            <td class="text-end">R$ {{ item.produto.valor }}</td>
                                            <td class="text-end">
                                                <strong>R$ {{ item.get_total_item_price }}</strong>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-light">
                                        <tr>
                                            <td colspan="4" class="text-end"><strong>Total do Pedido:</strong></td>
                                            <td class="text-end">
                                                <h4 class="text-success mb-0">R$ {{ pedido.total }}</h4>
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Informações de Checkout -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-user me-2"></i>Informações do Cliente</h5>
                        </div>
                        <div class="card-body">
                            <form action="{% url 'finalizar_pedido' %}" method="post" id="checkout-form">
                                {% csrf_token %}
                                
                                <!-- Informações do usuário -->
                                <div class="mb-3">
                                    <label class="form-label">Cliente</label>
                                    <div class="border rounded p-3 bg-light">
                                        <strong>{{ user.nome }}</strong><br>
                                        <small class="text-muted">{{ user.email }}</small><br>
                                        <small class="text-muted">{{ user.telefone }}</small><br>
                                        <small class="text-muted">{{ user.endereco }}</small>
                                    </div>
                                </div>

                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Utilizaremos o endereço cadastrado em seu perfil para organizar a entrega.
                                </div>
                                
                                <!-- Botões de ação -->
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-success btn-lg" id="finalizar-btn">
                                        <i class="fas fa-check me-2"></i>Finalizar Pedido
                                    </button>
                                    <a href="{% url 'catalogo' %}" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>Continuar Comprando
                                    </a>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Informações importantes -->
                    <div class="card mt-3">
                        <div class="card-body">
                            <h6 class="card-title text-success">
                                <i class="fas fa-info-circle me-2"></i>Informações Importantes
                            </h6>
                            <ul class="list-unstyled small">
                                <li><i class="fas fa-check text-success me-2"></i>Compra coletiva - preços especiais</li>
                                <li><i class="fas fa-truck text-success me-2"></i>Entrega conforme cronograma</li>
                                <li><i class="fas fa-shield-alt text-success me-2"></i>Produtos naturais selecionados</li>
                                <li><i class="fas fa-phone text-success me-2"></i>Suporte via WhatsApp</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="text-center py-5">
                <div class="card mx-auto" style="max-width: 400px;">
                    <div class="card-body">
                        <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                        <h4>Seu carrinho está vazio</h4>
                        <p class="text-muted">Adicione produtos ao seu carrinho para continuar com o pedido.</p>
                        <a href="{% url 'catalogo' %}" class="btn btn-primary">
                            <i class="fas fa-store me-2"></i>Ver Catálogo
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <script src="{% static 'app/js/bootstrap.min.js' %}"></script>
    <script>
        // Validação do formulário no frontend
        document.getElementById('checkout-form')?.addEventListener('submit', function(e) {
            const form = this;
            const submitBtn = document.getElementById('finalizar-btn');
            
            // Desabilita botão para evitar duplo clique
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';
            
            // Se houver erro de validação, reabilita o botão
            setTimeout(() => {
                if (!form.checkValidity()) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Finalizar Pedido';
                }
            }, 100);
        });

        // Formatação do CEP
        const cepInput = document.querySelector('input[name="cep"]');
        if (cepInput) {
            cepInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 5) {
                    value = value.replace(/^(\d{5})(\d)/, '$1-$2');
                }
                e.target.value = value;
            });
        }
    </script>
</body>
</html>